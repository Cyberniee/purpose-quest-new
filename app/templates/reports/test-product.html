<!DOCTYPE html>
<html>

<head>
    <title>Life Story Form</title>
    {% include '_common_head.html' %}

</head>

<body class="d-flex flex-column min-vh-100">
    {% include 'header.html' %}

    <div class="container mt-5 flex-grow-1">
        <h1 class="text-center">Your Personal Life Story Analysis</h1>
        <p class="text-muted text-center pSub mx-auto">
            Your privacy is paramount. All information you provide is encrypted before being sent to our servers.
            Our specially trained AI will process your input directly into a report, which only you will see. No
            humans
            are
            involved in this process. Furthermore, your input is not used for training and is stored temporarily
            with encryption during processing, and is deleted once your report is ready.
            Rest assured, your story remains solely yours.
        </p>

        <form class="text-center mx-auto" id="form">
            <h3 class="mt-5 mb-3 text-center">Share with us the story of your life as it stands now, weaving in your
                dreams, challenges, and values.</h3>
            <div class="container">
                <label for="story">We'd love to get to know you better. Dive deep into your current life
                    situation and your feelings about it. Reflect on moments when you've felt a strong desire for
                    change
                    and the experiences that have shaped these feelings. Think about the driving forces in your
                    life,
                    the values you stand for, and the challenges that have tested those values. Envision your
                    future:
                    the dreams, aspirations, and scenarios you see for yourself. Remember, this is your story; every
                    detail offers deeper insight into who you are and where you'd like to be. The more you share,
                    the
                    better we can assist in guiding you towards the meaningful work and life you desire.

                </label>
                <textarea class="form-control auto-expand mb-4" id="story" rows="5" style="height:auto;" required></textarea>
            </div>


            <div class="row justify-content-center pb-4">
                <button type="submit" class="btn btn-primary">Submit</button>
            </div>
        </form>

        <div aria-live="polite" aria-atomic="true" class="position-relative">
            <div id="toast-container" class="position-absolute top-0 end-0"></div>
        </div>

    </div>
    <div id="product-data" data-product-slug="{{ product_slug }}" data-token-id="{{ token_id }}"></div>

    <script type="module">
        import { autosave } from '/static/js/autosave.js';
        import { showToast } from '/static/js/showToast.js';

        document.querySelector("#form").addEventListener("submit", function (event) {
            const storyTextarea = document.getElementById("story");
            const story = storyTextarea.value;

            // Check if the story is empty
            if (!story.trim()) {
                // Prevent submission
                event.preventDefault();

                // Highlight the textarea with a red border
                storyTextarea.classList.add('border-danger');

                // Show the toast message
                showToast("Error", "Please provide your story before submitting.", 5000);
                return; // Exit the function early
            }

            const productDataElement = document.getElementById("product-data");
            const productSlug = productDataElement ? productDataElement.getAttribute("data-product-slug") : null;
            const tokenId = productDataElement ? productDataElement.getAttribute("data-token-id") : null;
            console.log(productSlug)

            function autoExpand(textarea) {
                // Reset height first to get accurate scrollHeight for content
                textarea.style.height = 'auto';
                if (textarea.scrollHeight > textarea.clientHeight) {
                    textarea.style.height = textarea.scrollHeight + 'px';
                }
            }

            document.querySelectorAll('.auto-expand').forEach(function (element) {
                element.addEventListener('input', function () {
                    autoExpand(element);
                });
                // Call once initially to set the correct height
                autoExpand(element);
            });


            // Send the data
            fetch("/report/submit_story", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    product_slug: productSlug,
                    token_id: tokenId,
                    story: story
                })
            }).then(response => response.json())
                .then(data => {
                    if (data.status === 202) {
                        window.location.href = `/account?task_id=${data.task_id}`;
                    }
                }).catch(error => {
                    console.error("Error:", error);
                });
        });

        // Listen for input in the textarea to remove the error state once the user starts typing
        document.querySelector("#story").addEventListener("input", function (event) {
            const storyTextarea = document.getElementById("story");
            if (storyTextarea.classList.contains('border-danger')) {
                storyTextarea.classList.remove('border-danger');
            }

            // This is where the autosave logic is
            let keystrokeCount = 0;
            const AUTOSAVE_TRIGGER = 50; // Change this to any number you want

            keystrokeCount++;
            if (keystrokeCount >= AUTOSAVE_TRIGGER) {
                autosave();
                keystrokeCount = 0; // Reset the keystroke count
            }
        });
    </script>
    {% include 'account_footer.html' %}

</body>

</html>