<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purpose Quest Report</title>
    {% include '_common_head.html' %}
    <link rel="stylesheet" href="{{ url_for('static', filename='productStyle.css') }}">
</head>

<body class="d-flex flex-column min-vh-100">
    {% include 'header.html' %}

    <main class="container my-5 flex-grow-1">
        <section class="py-2">
            <div class="container">
                <div class="row">
                    <h3 class="w-100 text-center">Introduction</h3>
                    <div class="promo pe-md-3 pe-lg-5">
                        <p class="text-center">Welcome to your lite version of the personalized evaluation report! This
                            report is designed
                            to help you get an idea of what Purpose Quest can do for you, by helping you
                            understand one potential sources of meaning and purpose in your life based on your story. It
                            is
                            inspired by the principles of Logotherapy, which focuses on finding meaning through
                            personal experiences, relationships, and values. You can use this report as a guide for
                            self-reflection and exploration, and it can also be integrated into your journaling
                            practice to deepen your understanding of yourself and your search for meaning.</p>
                    </div>
                </div>
            </div>
        </section>

        <div id="report-container"></div>

        <section class="cta-motivator-section py-4 bg-light">
            <div class="container">
                <div class="row justify-content-center">
                    <div class="col-12 col-md-8 text-center">
                        <h3>Unlock Your Full Potential!</h3>
                        <p>Ready to dive deeper into your journey of self-discovery? The full version of Purpose Quest
                            offers comprehensive insights and detailed analysis, tailored just for you. Explore these
                            key areas:</p>
                        <ul class="list-unstyled">
                            <li>1. In-depth Analysis of Your Memorable Experiences</li>
                            <li>2. Detailed Exploration of Your Aspirations and Goals</li>
                            <li>3. Comprehensive Understanding of Life Lessons and Their Impact</li>
                            <li>4. Insights into Influential People and Their Influence on You</li>
                            <li>5. Reflection on Daily Joy and Consistent Sources of Happiness</li>
                            <li>6. Visioning and Crafting Your Legacy for the Future</li>
                        </ul>
                        <button class="btn btn-primary buy-btn mt-auto" data-product-id="{{ pq_prod.product_id }}"
                            data-product-name="{{ pq_prod.name }}" data-product-slug="{{ pq_prod.product_slug }}"
                            data-product-price="{{ pq_prod.price }}" data-product-price-id="{{ pq_prod.price_id }}">Buy
                            for â‚¬{{pq_prod.price}}</button>
                    </div>
                </div>
            </div>
        </section>


        <div id="report-data" data-report="{{ report_data }}"></div>
    </main>
    {% include 'account_footer.html' %}


    <script type="module">
        import { handlePurchase } from '/static/js/handlePurchase.js';
        import { stripe } from '/static/js/_jsEnv.js';

        function generateHtmlFromJson(jsonObject) {
            const htmlParts = [];
            let imageCounter = 1;
            let alternate = false;

            for (const [key, sectionData] of Object.entries(jsonObject)) {
                const sectionHeader = sectionData.Header ? `<h3 class="w-100">${sectionData.Header}</h3>` : '';
                const textContent = generateTextContent(sectionData, sectionHeader); // Pass the header to the textContent function
                const imageContent = generateImageContent(key, imageCounter);
                const sectionOrder = alternate ? textContent + imageContent : imageContent + textContent;

                htmlParts.push(`
            <section class="py-2">
                <div class="container">
                    <div class="row my-5">
                        ${sectionOrder}
                    </div>
                </div>
            </section>
        `);

                imageCounter++;
                alternate = !alternate;
            }

            return htmlParts.join('');
        }

        function generateTextContent(sectionData, sectionHeader) {
            let textContent = '';

            textContent += `<div class="col-12 col-md-7 align-self-center">`;
            if (sectionHeader) {
                textContent += `<h3 class="w-100">${sectionHeader.replace(/\n/g, '<br>')}</h3>`; // Replace \n with <br> in section header
            }
            textContent += `<div class="promo pe-md-3 pe-lg-5">`;
            for (const [innerKey, value] of Object.entries(sectionData)) {
                if (innerKey === 'Header') {
                    continue;
                } else if (innerKey === 'Content') {
                    if (Array.isArray(value)) {
                        for (const element of value) {
                            if (typeof element === 'string') {
                                textContent += `<p>${element.replace(/\n/g, '<br>')}</p>`; // Replace \n with <br> in strings
                            } else if (typeof element === 'object') {
                                textContent += generateSectionHtml(element);
                            }
                        }
                    } else {
                        textContent += `<p>${value.replace(/\n/g, '<br>')}</p>`; // Replace \n with <br> in strings
                    }
                } else if (innerKey === 'Topics' || innerKey === 'Points') {
                    for (const topic of value) {
                        textContent += generateSectionHtml(topic);
                    }
                } else if (typeof value === 'object') {
                    textContent += generateSectionHtml(value);
                }
            }
            textContent += `</div></div>`; // Closing divs for promo and column

            return textContent;
        }

        function generateImageContent(key, imageCounter) {
            let imageContent = '';

            imageContent += `<div class="col-12 col-md-5 align-self-center">`;
            imageContent += `<div class="product-cover-holder text-center">`;
            imageContent += `<img class="img-fluid rounded report-img product-cover" src="/static/images/purpose-quest-${imageCounter}.png" alt="${key} cover">`;
            imageContent += `</div></div>`; // Closing divs for product-cover-holder and column

            return imageContent;
        }

        function generateSectionHtml(data) {
            let html = '';
            if (data.Header) {
                html += `<h6>${data.Header.replace(/\n/g, '<br>')}</h6>`; // Replace \n with <br> in subheaders
            }
            if (data.Content) {
                if (typeof data.Content === 'string') {
                    html += `<p>${data.Content.replace(/\n/g, '<br>')}</p>`; // Handle strings
                } else if (typeof data.Content === 'object') {
                    // Check if it's a simple object or a nested structure
                    if (Object.values(data.Content).every(value => typeof value === 'string')) {
                        // Handle as a bulleted list if all values are strings
                        html += `<ul>`;
                        Object.entries(data.Content).forEach(([key, value]) => {
                            html += `<li><strong>${key.replace(/([A-Z])/g, ' $1').trim()}: </strong>${value.replace(/\n/g, '<br>')}</li>`;
                        });
                        html += `</ul>`;
                    } else {
                        // Recursively handle nested objects
                        Object.entries(data.Content).forEach(([key, value]) => {
                            if (typeof value === 'object') {
                                // For nested objects, call generateSectionHtml recursively
                                html += `<strong>${key.replace(/([A-Z])/g, ' $1').trim()}:</strong>`;
                                html += generateSectionHtml({ Content: value });
                            } else {
                                // For strings, format directly
                                html += `<p>${key.replace(/([A-Z])/g, ' $1').trim()}: ${value.replace(/\n/g, '<br>')}</p>`;
                            }
                        });
                    }
                }
            }
            return html;
        }


        document.addEventListener('DOMContentLoaded', () => {


            const rawData = document.getElementById('report-data').getAttribute('data-report');
            console.log("This we get from the server:", rawData)
            const reportJson = JSON.parse(rawData);
            console.log("This we get after parsing it, and we'll use this in the rest of the code:", reportJson)
            const reportHtml = generateHtmlFromJson(reportJson);
            document.getElementById('report-container').innerHTML = reportHtml;

            const buyButton = document.querySelector('.buy-btn');

            if (buyButton) {
                buyButton.addEventListener('click', () => {
                    const productId = buyButton.getAttribute('data-product-id');
                    const productName = buyButton.getAttribute('data-product-name');
                    const productPrice = buyButton.getAttribute('data-product-price');
                    const productPriceId = buyButton.getAttribute('data-product-price-id');
                    const productSlug = buyButton.getAttribute('data-product-slug');
                    handlePurchase(productId, productName, productPrice, productPriceId, productSlug, stripe);
                });
            }
        });
    </script>
</body>


</html>