<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account</title>
    {% include '_common_head.html' %}
</head>

<body class="d-flex flex-column min-vh-100">
    {% include 'motivator_modal.html' %}
    {% include 'header.html' %}

    <main class="container my-5 flex-grow-1">
        <section class="bg-white p-2 products-section">
            <h3 class="text-center">Welcome, {{ user_name }}</h3>

        </section>
        <!-- Top section for available products -->
        <!-- Products section -->
        <section class="mb-5 bg-white p-4 products-section">
            <h3 class="text-center pb-2">Your Products</h3>
            <div id="products-container" class="row justify-content-center">
                <p class="col-12 text-center">Loading products...</p>
            </div>
        </section>

        <!-- Reports section -->
        <section class="mb-5 bg-white p-4 reports-section">
            <h3 class="text-center pb-2">Reports</h3>
            <div id="reports-container" class="row justify-content-center">
                <p class="col-12 text-center">Loading reports...</p>
            </div>
        </section>

        <!-- Available for purchase -->
        <section class="mb-5 bg-white p-4">
            <h3 class="text-center pb-2">Products for Purchase</h3>
            <div id="available-products-container" class="product-flex-grid row justify-content-center">
                <p class="col-12 text-center">Loading available products...</p>
            </div>
        </section>


        <!-- Past purchases -->
        <section class="mb-5 bg-white p-4">
            <h3 class="text-center pb-2">Past Purchases</h3>
            <div class="card">
                <div class="card-header d-none d-md-flex justify-content-between text-muted px-3">
                    <span class="col-4 col-md-4">Product Name</span>
                    <span class="col-4 col-md-4">Purchase Date</span>
                    <span class="col-4 col-md-4">Validity</span>
                </div>
                <div class="table-responsive">
                    <ul id="past-purchases-container" class="list-group list-group-flush">
                        <li class="list-group-item text-center">Loading past purchases...</li>
                    </ul>
                </div>
            </div>
        </section>

        {% if dev_mode %}
        <section class="mb-3 text-center">
            <button id="sync-stripe-btn" class="btn btn-secondary">
                ðŸ”„ Sync with Stripe
            </button>
        </section>
        {% endif %}


    </main>

    <div aria-live="polite" aria-atomic="true" class="position-relative">
        <div id="toast-container" class="position-absolute top-0 end-0"></div>
    </div>
    {% include 'account_footer.html' %}

    <div id="report-links" data-report-id="{{ report_links }}"></div>
    <!-- Unsure if this is still relevant in our new setup -->

    <script type="module">
        import { stripe } from '/static/js/_jsEnv.js';
        import { startProduct } from '/static/js/handleStartProduct.js';
        import { handlePurchase } from '/static/js/handlePurchase.js';
        import { showToast } from '/static/js/showToast.js';
        import { btnLoader } from '/static/js/addLoader.js';
        import { getTaskStatus, checkNewUser } from '/static/js/accountUtils.js';

        document.addEventListener('DOMContentLoaded', async () => {
            const userIdElement = document.getElementById('user-id');
            const userId = userIdElement?.getAttribute('data-user-id');

            showFlashToast();
            // checkNewUser(userId);

            const productContainer = document.getElementById('products-container');
            const reportContainer = document.getElementById('reports-container');
            const availableContainer = document.getElementById('available-products-container');
            const purchasesContainer = document.getElementById('past-purchases-container');

            // âœ… Attach sync button handler early
            const syncBtn = document.getElementById('sync-stripe-btn');
            if (syncBtn) {

                syncBtn.addEventListener('click', async () => {
                    syncBtn.disabled = true;
                    syncBtn.innerText = 'Syncing...';

                    try {
                        const res = await fetch('/account/sync_report_types', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' }
                        });

                        if (res.ok) {
                            location.reload();
                        } else {
                            const err = await res.json();
                            showToast('Sync Failed', err.detail || 'Unknown error');
                        }
                    } catch (err) {
                        console.error('Sync error:', err);
                        showToast('Sync Error', 'Check console for details.');
                    } finally {
                        syncBtn.disabled = false;
                        syncBtn.innerText = 'ðŸ”„ Sync with Stripe';
                    }
                });
            }

            // âœ… Now continue with your main product fetching
            try {
                const response = await fetch('/account/products');
                const data = await response.json();

                const notStarted = data.valid_products.filter(p => ["not started", "in progress", ""].includes(p.status));
                const generatingOrDone = data.valid_products.filter(p => ["generating", "processing", "done"].includes(p.status));


                populateProductCards(notStarted, productContainer, 'valid');
                populateProductCards(generatingOrDone, reportContainer, 'valid');
                populateProductCards(data.available_products, availableContainer, 'available');
                populatePastPurchases([...data.valid_products, ...data.invalid_products], purchasesContainer);
                attachProductBehaviors(data.valid_products, data.available_products);

            } catch (err) {
                console.error('Error fetching products:', err);
                productContainer.innerHTML = '<p class="col-12 text-center">Failed to load products.</p>';
                reportContainer.innerHTML = '<p class="col-12 text-center">Failed to load reports.</p>';
                availableContainer.innerHTML = '<p class="col-12 text-center">Failed to load available products.</p>';
                purchasesContainer.innerHTML = '<li class="list-group-item text-center">Failed to load past purchases.</li>';
            }
        });

        function showFlashToast() {
            const flashedMessageEl = document.getElementById('flashed-message');
            if (flashedMessageEl) {
                const title = flashedMessageEl.getAttribute('data-title');
                const message = flashedMessageEl.getAttribute('data-message');
                showToast(title, message);
            }
        }

        function attachProductBehaviors(validProducts = [], availableProducts = []) {
            const startButtons = document.querySelectorAll('.start-btn');
            const reportButtons = document.querySelectorAll('.report-btn');
            const buyButtons = document.querySelectorAll('.buy-btn');
            const btns = document.querySelectorAll('.btn-primary');

            btnLoader(btns);

            // Attach start behavior
            startButtons.forEach(button => {
                const card = button.closest('.valid-product-card');
                const status = card?.querySelector('.token-status-label')?.getAttribute('data-status')?.toLowerCase() || '';
                const tokenId = card?.getAttribute('data-token-id');
                const valid = card?.querySelector('.token-status-label')?.getAttribute('data-valid') === 'true';

                button.addEventListener('click', () => {
                    startProduct(tokenId);
                });
            });

            // Handle "Generating..." report buttons
            reportButtons.forEach(button => {
                const card = button.closest('.valid-product-card');
                const status = card?.querySelector('.token-status-label')?.getAttribute('data-status')?.toLowerCase() || '';
                const tokenId = card?.getAttribute('data-token-id');
                const valid = card?.querySelector('.token-status-label')?.getAttribute('data-valid') === 'true';

                if (valid && (status === 'generating' || status === 'processing')) {
                    getTaskStatus(tokenId, card);
                    card.classList.add("disabled-card");
                }
            });


            // Attach purchase behavior
            buyButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const productId = button.getAttribute('data-product-id');
                    const productName = button.getAttribute('data-product-name');
                    const productPrice = button.getAttribute('data-product-price');
                    const productPriceId = button.getAttribute('data-product-price-id');
                    handlePurchase(productId, productName, productPrice, productPriceId, stripe);
                });
            });
        }

        function populateProductCards(products, container, type) {
            container.innerHTML = '';
            if (!products || products.length === 0) {
                container.innerHTML = `<p class="col-12 text-center">No ${type} products available.</p>`;
                return;
            }
            container.className = 'dynamic-product-grid';


            products.forEach(product => {
                const card = document.createElement('div');
                // card.className = 'col-md-4 mb-4 d-flex justify-content-center';
                card.classList.add('mb-4');

                card.innerHTML = `
                    <div class="card product-card ${type}-product-card d-flex flex-column" 
                        data-token-id="${product.token_id}" 
                        data-product-id="${product.product_id}">

                        <div class="image-badge-container">
                            <img class="card-img-top image-max-h" src="${product.image}" alt="${product.name}" loading="lazy">
                            ${generateStatusBadge(product)}
                        </div>

                        <div class="card-body d-flex flex-column flex-grow-1">
                            <h5 class="card-title">${product.name}</h5>
                            <p class="card-text">${product.description}</p>

                            <!-- âœ… Progress section -->
                            <div class="progress-container pb-3" style="display:none;" 
                                data-product-id="${product.product_id}" 
                                data-task-id="${product.token_id}">
                                <div class="progress-label" data-product-id="${product.product_id}"></div>
                                <div class="progress mt-2">
                                    <div class="progress-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" 
                                        data-product-id="${product.product_id}" style="width: 0%;">
                                    </div>
                                </div>
                            </div>

                            ${getCardActionButton(product, type)}
                        </div> <!-- end .card-body -->
                    </div> <!-- end .card -->
                `;

                container.appendChild(card);
            });
        }

        function getCardActionButton(product, type) {
            const status = product.status || '';

            if (type === 'valid') {
                if (status === 'done') {
                    return `<a class="btn btn-primary mt-auto" 
                        href="/report/${product.report_id}" 
                        role="button">View Report</a>`;
                }

                if (status === 'generating' || status === 'processing') {
                    return `<button class="btn btn-secondary report-btn mt-auto" disabled data-product-id="${product.product_id}" data-token-id="${product.token_id}" >Generating...</button>`;
                }

                return `<button class="btn btn-primary start-btn mt-auto"
                    data-product-id="${product.product_id}" 
                    data-token-id="${product.token_id}">
                    Start
                </button>`;
            }

            if (type === 'invalid') {
                const label = product.status === 'done' ? 'Open Report' : 'Generating...';
                return `<a class="btn btn-primary mt-auto" 
                    href="/report/${product.report_id || product.token_id}" 
                    role="button">${label}</a>`;
            }

            if (type === 'available') {
                return `<button class="btn btn-primary buy-btn mt-auto" 
                    data-product-id="${product.product_id}"
                    data-product-name="${product.name}" 
                    data-product-price="${product.price}"
                    data-product-price-id="${product.price_id}">
                    Buy for â‚¬${product.price}
                </button>`;
            }

            return '';
        }

        function generateStatusBadge(product) {
            const status = product.status || '';
            let badgeClass = 'bg-secondary';
            let label = '...';
            if (!status) {
                badgeClass = 'bg-primary';
                label = 'New';
            } else if (status === 'in progress') {
                badgeClass = 'bg-warning text-dark';
                label = 'In progress';
            } else if (status === 'not started') {
                badgeClass = 'bg-primary';
                label = 'New!';
            } else if (status === 'done') {
                badgeClass = 'bg-success';
                label = 'Done';
            } else if (status === 'generating') {
                badgeClass = 'bg-success';
                label = 'Generating...';
            }
            return `<span class="token-status-label badge ${badgeClass}" 
                data-status="${status}" 
                data-valid="${product.valid}" 
                data-product-id="${product.product_id}">
                ${label}
            </span>`;
        }

        function populatePastPurchases(products, container) {
            container.innerHTML = '';

            if (!products || products.length === 0) {
                container.innerHTML = '<li class="list-group-item text-center">No past purchases available</li>';
                return;
            }

            products.forEach(product => {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between';

                const nameSpan = document.createElement('span');
                nameSpan.className = 'col-4 col-md-4';
                nameSpan.textContent = product.name;

                const dateSpan = document.createElement('span');
                dateSpan.className = 'col-4 col-md-4';
                dateSpan.textContent = formatDate(product.date);

                const validSpan = document.createElement('span');
                validSpan.className = 'col-4 col-md-4';
                validSpan.textContent = product.valid ? 'available' : 'used';

                li.appendChild(nameSpan);
                li.appendChild(dateSpan);
                li.appendChild(validSpan);

                container.appendChild(li);
            });
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return isNaN(date.getTime()) ? '-' : date.toLocaleDateString(undefined, {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }
    </script>


</body>

</html>