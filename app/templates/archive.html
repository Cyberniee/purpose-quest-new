<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Your Journal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    {% include '_common_head.html' %}
    <link rel="stylesheet" href="{{ static_file_url('archive_calendar_style.css') }}">

</head>

<body class="archive-body">
    {% include 'partials/_mobile_header.html' %}

    <!-- Main Container -->
    <div class="container-fluid archive-container">
        <div class="row min-vh-100">

            <!-- Sidebar (desktop only) -->
            <div class="col-md-3 col-lg-2 d-none d-md-block bg-light p-0 border-end">
                {% include '_side_menu.html' %}
            </div>

            <!-- Main Content -->
            <div class="col-12 col-md-9 col-lg-10 p-4">

                <!-- Header -->
                <div class="d-flex flex-column align-items-center mb-4 text-center">
                    <h2 class="mb-3" id="archive-title">Your Journal</h2>
                    <div class="d-flex gap-2 justify-content-center">
                        <button class="btn btn-primary active" id="calendar-view-btn">Calendar View</button>
                        <button class="btn btn-secondary" id="list-view-btn">List View</button>
                    </div>
                </div>

                {% include '_archive_calendar.html' %}
                {% include '_archive_list.html' %}
            </div>
        </div>

        <!-- JS Script to render calendar and mock data -->
        <script type="module">
            import { initCalendar } from '../static/js/calendar.js';
            import { setupMobileSidebar } from '/static/js/mobile_ui.js';



            let journalDates = [];       // for calendar
            let journalListCache = [];   // for list view

            // Fetch dates only for calendar (minimal payload)
            async function fetchJournalDates() {
                try {
                    const res = await fetch('/api/journal/all_dates');
                    const { dates } = await res.json();
                    journalDates = dates;
                    console.log('dates: ', journalDates)
                } catch (err) {
                    console.error("Failed to fetch journal dates", err);
                }
            }

            // Fetch paginated journal entry previews for list view
            async function fetchPaginatedEntries() {
                try {
                    const res = await fetch('/api/journal/paginated?page=1&limit=10');
                    const { entries } = await res.json();
                    journalListCache = entries;
                } catch (err) {
                    console.error("Failed to fetch paginated entries", err);
                }
            }

            // Use dateKey to load preview into calendar panel
            function loadJournalEntry(dateKey) {
                const match = journalListCache.find(entry => entry.entry_date === dateKey);
                const container = document.getElementById("entry-preview-container");
                const dateTitle = document.getElementById("entry-date-title");
                const summary = document.getElementById("entry-summary-text");
                const excerpt = document.getElementById("entry-excerpt-text");
                const wordCount = document.getElementById("entry-word-count");
                const viewBtn = document.getElementById("view-entry-btn");
                const editBtn = document.getElementById("edit-entry-btn");

                if (match) {
                    dateTitle.innerText = match.label;
                    summary.innerText = match.summary || '';
                    excerpt.innerText = match.preview || '';
                    wordCount.innerText = match.word_count ? `${match.word_count} words` : '';
                    viewBtn.href = `/journal/${match.id}`;
                    editBtn.href = `/journal/${match.id}`;
                } else {
                    dateTitle.innerText = new Date(dateKey).toDateString();
                    summary.innerText = '';
                    excerpt.innerText = "No journal entry found for this date.";
                    wordCount.innerText = '';
                    viewBtn.href = "#";
                    editBtn.href = "#";
                }

                container.classList.remove("d-none");
            }

            function renderListView() {
                const container = document.getElementById("entry-list-container");
                container.innerHTML = "";

                journalListCache.forEach(entry => {
                    const card = document.createElement("div");
                    card.className = "bg-light p-4 rounded mb-4 shadow-sm";

                    card.innerHTML = `
            <h5 class="mb-1">${entry.label}</h5>
            <p class="text-muted fw-semibold">${entry.summary || ''}</p>
            <p class="mb-2">${entry.preview}</p>
            <div class="d-flex justify-content-between align-items-center">
                <small>${entry.word_count || 0} words</small>
                <div class="d-flex gap-2">
                    <a href="/journal/${entry.id}" class="btn btn-secondary btn-sm">üëÅ View</a>
                    <a href="/journal/${entry.id}" class="btn btn-primary btn-sm">‚úèÔ∏è Edit</a>
                </div>
            </div>
        `;

                    container.appendChild(card);
                });
            }

            document.addEventListener("DOMContentLoaded", async () => {
                setupMobileSidebar();

                // Load data for both views
                await Promise.all([fetchJournalDates(), fetchPaginatedEntries()]);

                // Init calendar
                initCalendar({
                    displaySelector: ".display",
                    daysContainerSelector: ".days",
                    leftArrowSelector: ".left",
                    rightArrowSelector: ".right",
                    selectedOutputSelector: ".selected",
                    onDateSelect: loadJournalEntry,
                    journalEntryDates: journalDates
                });

                // Show calendar by default
                document.getElementById("calendar-container-wrapper").classList.remove("d-none");
                document.getElementById("archive-list-view").classList.add("d-none");

                // Button toggling
                const calendarBtn = document.getElementById("calendar-view-btn");
                const listBtn = document.getElementById("list-view-btn");

                calendarBtn.addEventListener("click", () => {
                    document.getElementById("calendar-container-wrapper").classList.remove("d-none");
                    document.getElementById("archive-list-view").classList.add("d-none");
                });

                listBtn.addEventListener("click", () => {
                    document.getElementById("calendar-container-wrapper").classList.add("d-none");
                    document.getElementById("archive-list-view").classList.remove("d-none");
                    renderListView(); // reuse local cache
                });


                const sidebarOverlay = document.getElementById("sidebar-overlay");
                const hamburgerBtn = document.getElementById("hamburger-btn");

                function closeSidebar() {
                    sidebarOverlay.classList.add("d-none");
                    hamburgerBtn.classList.remove("hidden");
                }

                hamburgerBtn.addEventListener("click", () => {
                    sidebarOverlay.classList.remove("d-none");
                    hamburgerBtn.classList.add("hidden");
                });

                sidebarOverlay.addEventListener("click", (e) => {
                    if (e.target.id === "sidebar-overlay") {
                        closeSidebar();
                    }
                });

                // Also close sidebar when clicking any link inside it
                setTimeout(() => {
                    sidebarOverlay.querySelectorAll("a").forEach(link => {
                        link.addEventListener("click", closeSidebar);
                    });
                }, 0);
            });
        </script>

</body>

</html>