<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Account</title>
    {% include '_common_head.html' %}
<script> const imagesToPreload = [
            "{{ valid_products.image }}",
            "{{ invalid_products.image }}",
            "{{ available_products.image }}"
        ];

        imagesToPreload.forEach(imgSrc => {
            const img = new Image();
            img.src = imgSrc;
        }); 
    </script>
</head>
<body class="d-flex flex-column min-vh-100">

    {% include 'header.html' %}

    <div class="flex-grow-1 d-flex justify-content-center align-items-center">
<div class="container">
<div class="card bg-white my-5">
<div class="card-body" id="product-content-body">
<!-- Top section for available products -->
<div class="mb-4">
<h3>Your Products</h3>
                        {% if valid_products|length &gt; 0 %}
                        {% for product in valid_products %}
                        <div class="card mx-auto" style="width: 18rem;">
<img class="card-img-top" loading="lazy" src="{{ product.image }}"/>
<span class="token-status-label badge" data-product-id="{{ product.product_id }}" data-status="{{ product.status }}" data-valid="{{ product.valid }}"></span>
<h5 class="card-title">{{ product.product_name }}</h5>
<div class="card-body text-center" style="max-width: 300px;">
<h5 class="card-title">{{ product.name }}</h5>
<p class="card-text">{{ product.description }}</p>
<div class="progress-label" data-product-id="{{ product.product_id }}"></div>
<div class="progress-container" data-product-id="{{ product.product_id }}">
<div id="task-progress-{{ product.product_id }}"></div>
</div>
<button class="btn btn-primary start-btn" data-product-id="{{ product.product_id }}" data-product-slug="{{ product.product_slug }}">Start</button>
</div>
                            {% endfor %}
                            {% else %}
                            <p>No products available in your account.</p>
                            {% endif %}
                        </div>
</div><div class="mb-4"><h3>Report Status</h3><div id="report-status">Awaiting report generation...</div><a href="#" id="report-link" style="display:none;">View Report</a></div>
<!-- Reports section -->
<div class="mb-4">
<h3>Reports</h3>
                        {% for product in reports %}
                        <div class="card mx-auto" style="width: 18rem;">
<h5 class="card-title">{{ product.product_name }}</h5>
<div class="card-body text-center" style="max-width: 300px;">
<a class="btn btn-primary" href="/report/{{ product.token_id }}">View Report</a>
</div>
</div>
                        {% endfor %}
                    </div>
<!-- Bottom section for products available for purchase -->
<hr/>
<div class="my-4">
<h3>Products for Purchase</h3>
                        {% for product in available_products %}
                        <div class="card mx-auto" style="width: 18rem;">
<img class="card-img-top" src="{{ product.image }}"/>
<h5 class="card-title">{{ product.product_name }}</h5>
<div class="card-body text-center" style="max-width: 300px;">
<h5 class="card-title">{{ product.name }}</h5>
<p class="card-text">{{ product.description }}</p>
<button class="btn btn-success buy-btn" data-product-id="{{ product.product_id }}" data-product-name="{{ product.name }}" data-product-price="{{ product.price }}">Buy</button>
</div>
                            {% endfor %}
                        </div>
</div>
<div class="mb-4">
<div class="card" style="width: 18rem;">
<div class="card-header">
                                Past purchases
                            </div>
<ul class="list-group list-group-flush">
                                {% if invalid_products|length &gt; 0 %}
                                {% for product in invalid_products %}
                                <li class="list-group-item">{{ product.product_name }}</li>
                                {% endfor %}
                                {% else %}
                                <li class="list-group-item">No past purchases available</li>
                                {% endif %}
                            </ul>
</div>
</div>
</div>
</div>
</div>
</div>
<div aria-atomic="true" aria-live="polite" style="position: relative; z-index: 9999;">
<div id="toast-container" style="position: absolute; top: 0; right: 0;"></div>
</div>

    {% include 'account_footer.html' %}

    <div data-user-id="{{ user_id|safe }}" id="user-id"></div>
<script type="module">
        import { stripe } from '/static/js/_utils.js';
        import { startProduct } from '/static/js/handleStartProduct.js';
        import { handlePurchase } from '/static/js/handlePurchase.js';
        import { showToast } from '/static/js/showToast.js';

        document.addEventListener('DOMContentLoaded', function () {

            function updateTaskProgress(taskId) {
                fetch(`/task_status/${taskId}`)
                    .then(response => response.json())
                    .then(data => {
                        const productElement = document.querySelector(`[data-task-id="${taskId}"]`);
                        const progressDiv = productElement.querySelector('.progress-container');
                        progressDiv.innerHTML = `Task Progress: ${data.status} - ${data.result.progress || ''}`;

                        if (data.status === 'completed') {
                            const reportLink = document.createElement('a');
                            reportLink.href = `/report/${taskId}`;
                            reportLink.innerText = 'View Report';
                            productElement.appendChild(reportLink);
                        }
                    });
            }

            const taskId = "{{ task_id }}";
            if (taskId && taskId !== "None") {
                setInterval(() => updateTaskProgress(taskId), 5000);  // Check every 5 seconds
            }

            const userIdElement = document.getElementById('user-id');
            const userId = userIdElement.getAttribute('data-user-id');

            const startButtons = document.querySelectorAll('.start-btn');
            const buyButtons = document.querySelectorAll('.buy-btn');

            startButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const productSlug = button.getAttribute('data-product-slug');
                    startProduct(productSlug);
                });
            });

            buyButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const productId = button.getAttribute('data-product-id');
                    const productName = button.getAttribute('data-product-name');
                    const productPrice = button.getAttribute('data-product-price');
                    handlePurchase(productId, productName, productPrice, stripe);
                });
            });

            let intervalId;

            function checkTokenStatus() {
                $.ajax({
                    url: 'report/check_token_status',
                    type: 'GET',
                    success: function (response) {
                        const productId = response.product_id;
                        const statusElement = $(`.token-status-label[data-product-id=${productId}]`);
                        const startButton = $(`.start-btn[data-product-id=${productId}]`);
                        const progressElement = $(`.progress-label[data-product-id=${productId}]`);

                        statusElement.removeClass('badge-primary badge-secondary badge-success');

                        switch (response.status) {
                            case 'viewing':
                                statusElement.addClass('badge-primary').text('Viewing');
                                startButton.prop('disabled', true).text('Being Used');
                                break;
                            case 'processing':
                                statusElement.addClass('badge-secondary').text('Processing');
                                updateTaskProgress(taskId);
                                break;
                            default:
                                statusElement.addClass('badge-success').text('Open');
                                progressElement.text('');
                                startButton.prop('disabled', false).text('Start');
                                break;
                        }
                    },
                    error: function (jqXHR) {
                        console.log("Error:", jqXHR.statusText);

                        let errorMessage;
                        try {
                            const errorResponse = JSON.parse(jqXHR.responseText);
                            errorMessage = errorResponse.message || "An unexpected error occurred.";
                        } catch (e) {
                            errorMessage = "An unexpected error occurred.";
                        }
                        showToast("Error", errorMessage);
                    }
                });
            }
        });
    </script>

<script>
    // Function to poll the server for status update
    function pollForStatus(taskId) {
        // Endpoint to check task status
        const statusUrl = `/task_status/${taskId}`;
        
        // Polling interval (initially set to 5 seconds)
        let interval = 5000;

        const statusInterval = setInterval(() => {
            fetch(statusUrl)
            .then(response => response.json())
            .then(data => {
                // Update the status in the "Report Status" section
                document.getElementById('report-status').textContent = data.status;

                // If the report is ready, show the report link and clear the interval
                if (data.status === 'completed') {
                    const reportLink = document.getElementById('report-link');
                    reportLink.href = `/report/${taskId}/<product_slug>`;  // You need to determine how to get the product_slug here
                    reportLink.style.display = 'block';
                    clearInterval(statusInterval);
                }
            })
            .catch(error => {
                console.error('Error fetching status:', error);
            });
        }, interval);
    }

    // Assuming you have a way to get the taskId (e.g., from a data attribute in the HTML)
    // You can start polling as soon as the page loads
    const taskId = '<task_id>';  // You need to determine how to get the task_id here
    pollForStatus(taskId);
</script>
</body>
</html>